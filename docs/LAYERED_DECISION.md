# 分层决策架构使用指南

## 架构概述

分层决策架构将交易系统分为四个层次：

```
感知层 (Perception)
    ↓
战略层 (Strategist) - 每小时运行
    ↓
战术层 (Trader) - 每3分钟运行
    ↓
执行层 (Execution)
```

### 优势

1. **降低 Token 消耗 70-90%**
   - 战略层仅每小时分析一次宏观环境
   - 战术层仅分析战略层推荐的 5-10 个币种
   - 避免每次都分析全部 50+ 个币种

2. **更清晰的决策逻辑**
   - 战略层：判断市场状态（牛市/熊市/震荡/恐慌）
   - 战术层：基于市场状态生成具体交易信号

3. **更好的信息整合**
   - 感知层整合：宏观经济、市场情绪、加密市场、美股、新闻
   - 战略层基于完整环境做判断
   - 战术层基于战略指导做交易

## 配置方法

### 1. 启用分层决策

在 `.env` 文件中添加：

```bash
LAYERED_DECISION_ENABLED=true
STRATEGIST_INTERVAL=3600     # 战略层间隔（秒）
TRADER_INTERVAL=180          # 战术层间隔（秒）
ENABLE_NEWS=false            # 是否启用新闻（可选）
```

### 2. 必要的 API Key

分层决策架构需要：

- **DeepSeek API Key**（必须）：用于战略层和战术层 LLM 分析
- **OpenAI API Key**（可选）：用于向量嵌入和长期记忆

```bash
DEEPSEEK_API_KEY=sk-xxxxx
OPENAI_API_KEY=sk-xxxxx  # 可选
```

### 3. 运行系统

```bash
# 启动系统（会自动检测分层决策配置）
python main.py
```

系统会根据 `LAYERED_DECISION_ENABLED` 配置自动选择运行模式：
- `true`：使用分层决策模式
- `false`：使用传统批量决策模式

## 运行频率说明

### 默认配置

- **战略层**：每 1 小时运行一次（3600秒）
  - 采集市场环境数据
  - 分析宏观市场状态
  - 输出市场制度判断和推荐币种

- **战术层**：每 3 分钟运行一次（180秒）
  - 基于战略层推荐的币种
  - 分析技术指标
  - 生成具体交易信号

- **数据采集**：每 3 秒更新一次（后台任务）
  - 持续更新市场价格和指标
  - 为战术层提供实时数据

### 自定义频率

根据需求调整：

```bash
# 更激进的配置（更频繁的战略更新）
STRATEGIST_INTERVAL=1800  # 30分钟
TRADER_INTERVAL=60        # 1分钟

# 更保守的配置（降低 API 调用）
STRATEGIST_INTERVAL=7200  # 2小时
TRADER_INTERVAL=300       # 5分钟
```

## 感知层数据源

感知层会采集以下数据（免费 API）：

### 1. 市场情绪
- Fear & Greed Index（恐慌贪婪指数）
- BTC/ETH 资金费率
- 多空比例

### 2. 宏观经济
- 美联储利率
- CPI 数据
- 美元指数（DXY）
- 黄金价格
- 原油价格

### 3. 美股市场
- S&P 500 指数
- NASDAQ 指数
- COIN 股价
- MSTR 股价

### 4. 加密市场
- 总市值
- BTC 市场占比
- 24小时交易量变化

### 5. 新闻事件（可选）
- RSS 新闻源（免费）
- CryptoPanic API（需要 API Key）

## 输出示例

### 战略层输出

```
市场状态: BEAR
风险等级: HIGH
置信度: 0.75
交易模式: defensive
建议现金比例: 60%
仓位系数: 0.5x

市场叙事: 宏观环境承压，加密市场处于调整期...

关键驱动因素:
  - 美联储维持高利率
  - 恐慌贪婪指数偏低
  - BTC 占比上升，资金避险

推荐币种: BTC, ETH, SOL
黑名单: DOGE, SHIB
```

### 战术层输出

```
BTC:
  信号: HOLD
  置信度: 0.65
  理由: 市场处于熊市，技术指标偏弱，暂时观望

ETH:
  信号: ENTER_LONG
  置信度: 0.55
  建议价格: $4000
  止损: $3800
  止盈: $4300
  理由: 虽然市场偏弱，但 ETH 相对 BTC 表现强势...
```

## 监控和调试

### 日志输出

系统会输出详细的运行日志：

```
✅ 战略层分析完成
市场状态: BEAR (置信度 0.75)
推荐币种: BTC, ETH, SOL

✅ 战术层分析完成，收到 2 个信号
BTC: HOLD
ETH: ENTER_LONG
```

### 数据完整度

感知层会报告数据完整度：

```
市场环境数据: 50% 完整
  ✓ 加密市场数据
  ✓ 市场情绪数据
  ✗ 美股数据（Yahoo Finance 限流）
  ✗ 宏观数据（部分失败）
```

即使部分数据源失败，系统也会继续运行（优雅降级）。

## 成本估算

假设：
- DeepSeek API: ~$0.14/1M tokens（输入），~$0.28/1M tokens（输出）
- 战略层：~2000 tokens/次
- 战术层：~3000 tokens/次

### 每日成本

**传统模式**（每分钟分析 50 个币种）：
- 每次调用：~50,000 tokens
- 每天：1440 次 × 50,000 = 72M tokens
- 成本：~$10-20/天

**分层决策模式**：
- 战略层：24 次 × 2,000 = 48k tokens
- 战术层：480 次 × 3,000 = 1.44M tokens
- 总计：~1.5M tokens
- 成本：~$0.30-0.50/天

**节省 95%+** 💰

## 常见问题

### Q: 可以不启用新闻吗？

可以。新闻采集较慢（10-20秒），且对决策影响有限。

建议初期禁用：`ENABLE_NEWS=false`

### Q: 数据源失败怎么办？

系统会优雅降级，部分数据源失败不会影响整体运行。
感知层会计算数据完整度，战略层会基于可用数据做分析。

### Q: 如何查看历史决策？

所有决策都保存在 PostgreSQL 数据库：
- `decisions` 表：决策记录
- `orders` 表：订单记录
- `trades` 表：交易记录
- `experiences` 表：交易经验

### Q: 可以只用战略层吗？

不可以。战略层输出市场判断，战术层负责生成交易信号。
两者配合使用才能完成决策流程。

## 下一步

1. 查看端到端测试：`python test_end_to_end_decision.py`
2. 测试感知层：`python test_perception_with_news.py`
3. 启动完整系统：`python main.py`
4. 查看 API 文档：`docs/API.md`

## 反馈和改进

如有问题或建议，请查看：
- 项目文档：`docs/`
- 配置示例：`.env.layered_example`
- 测试脚本：`test_*.py`
