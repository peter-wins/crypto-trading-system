# å†³ç­–å±‚åˆ°æ‰§è¡Œå±‚çš„æ•°æ®æµè¯¦è§£

## ğŸ“Š å®Œæ•´æ•°æ®æµå›¾

```
Strategist (æˆ˜ç•¥å±‚)
    â†“ MarketRegime
Trader (æˆ˜æœ¯å±‚)
    â†“ TradingSignal
TradingCoordinator
    â†“ process_trading_signal()
TradingExecutor
    â†“ OrderExecutor
Binance API
```

## 1ï¸âƒ£ æˆ˜ç•¥å±‚ â†’ æˆ˜æœ¯å±‚

### ä¼ é€’çš„æ•°æ®ç»“æ„ï¼š`MarketRegime`

**ä½ç½®**: `src/decision/trader.py:513-583` (`_build_regime_aware_prompt`)

**ä¼ é€’çš„å…³é”®å­—æ®µ**ï¼š

```python
MarketRegime {
    regime: Regime,                      # bull/bear/sideways/panic
    risk_level: RiskLevel,               # low/medium/high/extreme
    trading_mode: str,                   # "normal"/"defensive"/"aggressive"/"panic"
    position_sizing_multiplier: float,   # ä»“ä½ç³»æ•° (å¦‚ 0.5x)
    cash_ratio: float,                   # ç›®æ ‡ç°é‡‘æ¯”ä¾‹ (å¦‚ 0.8 = 80%ç°é‡‘)
    market_narrative: str,               # å¸‚åœºå™äº‹
    key_drivers: List[str],              # å…³é”®é©±åŠ¨å› ç´ 
    recommended_symbols: List[str],      # æ¨èå…³æ³¨å¸ç§
    blacklist_symbols: List[str],        # é»‘åå•å¸ç§
    time_horizon: TimeHorizon,           # å»ºè®®æŒä»“å‘¨æœŸ
    reasoning: str                       # æˆ˜ç•¥åˆ¤æ–­ç†ç”±
}
```

**ä¼ é€’æ–¹å¼**:

åœ¨ Trader æç¤ºè¯ä¸­æ›¿æ¢å ä½ç¬¦ï¼š

```python
prompt = (template
    .replace("{regime}", regime.regime.value)                      # â† å¸‚åœºçŠ¶æ€
    .replace("{risk_level}", regime.risk_level.value)              # â† é£é™©ç­‰çº§
    .replace("{trading_mode}", regime.trading_mode)                # â† äº¤æ˜“æ¨¡å¼
    .replace("{position_multiplier}", str(regime.position_sizing_multiplier))  # â† ä»“ä½ç³»æ•°
    .replace("{cash_ratio}", f"{regime.cash_ratio:.0%}")           # â† ç°é‡‘ç›®æ ‡
    .replace("{market_narrative}", regime.market_narrative)
    .replace("{key_drivers}", ', '.join(regime.key_drivers[:3]))
    # ...
)
```

**âš ï¸ å…³é”®é—®é¢˜**ï¼š
- âœ… æ•°æ®å·²ä¼ é€’
- âŒ **æç¤ºè¯æ¨¡æ¿ä¸­ç¼ºå°‘æ˜ç¡®çš„è¡ŒåŠ¨æŒ‡ä»¤**
- âŒ LLM ä¸çŸ¥é“ `panic` æ¨¡å¼ + `cash_ratio=0.8` åº”è¯¥è§¦å‘ä»€ä¹ˆæ“ä½œ

---

## 2ï¸âƒ£ æˆ˜æœ¯å±‚ â†’ æ‰§è¡Œå±‚

### ä¼ é€’çš„æ•°æ®ç»“æ„ï¼š`TradingSignal`

**ä½ç½®**: `src/models/decision.py:26-56`

**åŒ…å«çš„å­—æ®µ**ï¼š

```python
TradingSignal {
    # === åŸºç¡€ä¿¡æ¯ ===
    timestamp: int,                    # æ—¶é—´æˆ³(æ¯«ç§’)
    dt: datetime,                      # æ—¶é—´
    symbol: str,                       # äº¤æ˜“å¯¹ (å¦‚ "BTC/USDT:USDT")
    signal_type: SignalType,           # enter_long/exit_long/enter_short/exit_short/hold
    confidence: float,                 # ä¿¡å¿ƒåˆ†æ•° 0-1

    # === å»ºè®®å‚æ•° (å¯é€‰) ===
    suggested_price: Optional[Decimal],   # å»ºè®®ä»·æ ¼
    suggested_amount: Optional[Decimal],  # å»ºè®®æ•°é‡
    stop_loss: Optional[Decimal],         # æ­¢æŸä»·æ ¼
    take_profit: Optional[Decimal],       # æ­¢ç›ˆä»·æ ¼
    leverage: Optional[int],              # æ æ†å€æ•° 1-125x

    # === ç†ç”±å’Œé£é™© ===
    reasoning: str,                    # ä¿¡å·äº§ç”Ÿç†ç”±
    supporting_factors: List[str],     # æ”¯æŒå› ç´ 
    risk_factors: List[str],           # é£é™©å› ç´ 

    # === æ¥æº ===
    source: str                        # "strategist" æˆ– "trader"
}
```

**ä¼ é€’æµç¨‹**ï¼š

```python
# 1. Trader ç”Ÿæˆä¿¡å·å­—å…¸
signals: Dict[str, Optional[TradingSignal]] = await trader.batch_generate_signals_with_regime(
    market_regime=self.current_regime,
    symbols_snapshots=snapshots,
    portfolio=portfolio,
)

# 2. TradingCoordinator æ¥æ”¶ä¿¡å·
await self._execute_signals(signals, snapshots, strategy, portfolio)

# 3. å¯¹æ¯ä¸ªä¿¡å·è°ƒç”¨ TradingExecutor
for symbol, signal in signals.items():
    if signal and signal.signal_type != SignalType.HOLD:
        await trading_executor.process_trading_signal(
            symbol=symbol,
            signal=signal,              # â† TradingSignal å¯¹è±¡
            strategy=strategy,          # â† StrategyConfig å¯¹è±¡
            snapshot=snapshots[symbol], # â† å¸‚åœºæ•°æ®å¿«ç…§
            portfolio=portfolio         # â† å½“å‰æŠ•èµ„ç»„åˆ
        )
```

---

## 3ï¸âƒ£ æ‰§è¡Œå±‚å¤„ç†æµç¨‹

### TradingExecutor.process_trading_signal()

**ä½ç½®**: `src/execution/trading_executor.py:77-121`

**å¤„ç†æ­¥éª¤**ï¼š

```python
async def process_trading_signal(
    self,
    symbol: str,
    signal: TradingSignal,        # â† ä»æˆ˜æœ¯å±‚æ¥æ”¶
    strategy: StrategyConfig,     # â† ç­–ç•¥é…ç½®
    snapshot: Dict[str, Any],     # â† å¸‚åœºå¿«ç…§
    portfolio: Portfolio,         # â† å½“å‰æŒä»“
) -> bool:
    """
    1. éªŒè¯å’Œè°ƒæ•´ä¿¡å·å‚æ•°
       - å¹³ä»“ä¿¡å·ï¼šæ£€æŸ¥æ˜¯å¦æœ‰æŒä»“
       - å¦‚æœ suggested_amount ä¸ºç©ºï¼Œä½¿ç”¨æŒä»“å…¨é‡

    2. é£æ§æ ¡éªŒ
       - æ£€æŸ¥æ˜¯å¦ç¬¦åˆé£æ§è¦æ±‚
       - è¿ååˆ™æ‹’ç»ä¿¡å·

    3. è®¡ç®—æ­¢ç›ˆæ­¢æŸ
       - å¦‚æœä¿¡å·ä¸­æ²¡æœ‰æä¾›ï¼Œè‡ªåŠ¨è®¡ç®—

    4. æ‰§è¡Œä¿¡å·
       - è°ƒç”¨ _execute_signal() ä¸‹å•
    """
```

### å®é™…ä½¿ç”¨çš„å‚æ•°

ä» TradingSignal ä¸­æå–çš„å‚æ•°ï¼š

```python
# äº¤æ˜“æ–¹å‘
side = self._determine_order_side(signal)  # æ ¹æ® signal_type ç¡®å®š

# å…¥åœºä»·æ ¼
entry_price = signal.suggested_price or Decimal(str(snapshot["latest_price"]))

# äº¤æ˜“æ•°é‡
amount = signal.suggested_amount  # å¦‚æœä¸ºç©ºä¼šåœ¨éªŒè¯é˜¶æ®µå¡«å……

# æ­¢æŸæ­¢ç›ˆ
stop_loss = signal.stop_loss       # å¦‚æœä¸ºç©ºä¼šè‡ªåŠ¨è®¡ç®—
take_profit = signal.take_profit   # å¦‚æœä¸ºç©ºä¼šè‡ªåŠ¨è®¡ç®—

# æ æ†å€æ•°
leverage = signal.leverage         # LLM å†³å®šçš„æ æ†å€æ•°
```

---

## ğŸ” é—®é¢˜åˆ†æï¼šä¸ºä»€ä¹ˆé£æ§ä¸ç”Ÿæ•ˆï¼Ÿ

### é—®é¢˜é“¾æ¡ï¼š

```
Strategist è¾“å‡º:
{
    trading_mode: "panic",
    cash_ratio: 0.8,              # 80%ç°é‡‘
    position_sizing_multiplier: 0.5
}
    â†“ ä¼ é€’ç»™ Trader
Trader æç¤ºè¯åŒ…å«:
    "äº¤æ˜“æ¨¡å¼: panic"
    "ç›®æ ‡ç°é‡‘æ¯”ä¾‹: 80%"
    â†“ LLM ç”Ÿæˆ
TradingSignal {
    signal_type: "hold",          # â† é—®é¢˜åœ¨è¿™é‡Œï¼
    reasoning: "ç­‰å¾…æ›´å¥½çš„å…¥åœºæ—¶æœº"
}
    â†“ æ‰§è¡Œå±‚æ¥æ”¶
TradingExecutor:
    if signal.signal_type == HOLD:
        continue  # ä»€ä¹ˆéƒ½ä¸åš  â† é£æ§å¤±æ•ˆï¼
```

### æ ¹æœ¬åŸå› ï¼š

1. **æç¤ºè¯ç¼ºå°‘å¼ºåˆ¶è§„åˆ™**
   - âœ… æ•°æ®å·²ä¼ é€’ï¼ˆtrading_mode="panic", cash_ratio=0.8ï¼‰
   - âŒ æ²¡æœ‰æ˜ç¡®å‘Šè¯‰ LLMï¼š"panicæ¨¡å¼ä¸‹å¿…é¡»è¯„ä¼°æ˜¯å¦å¹³ä»“é«˜æ æ†æŒä»“"
   - âŒ LLM ä¸ç†è§£è¿™äº›å‚æ•°åº”è¯¥è§¦å‘ä»€ä¹ˆè¡ŒåŠ¨

2. **æ‰§è¡Œå±‚è¢«åŠ¨å“åº”**
   - TradingExecutor åªæ‰§è¡Œæ”¶åˆ°çš„ä¿¡å·
   - å¦‚æœä¿¡å·æ˜¯ `hold`ï¼Œå°±ä»€ä¹ˆéƒ½ä¸åš
   - **æ²¡æœ‰ä¸»åŠ¨æ£€æŸ¥**å½“å‰æŒä»“æ˜¯å¦ç¬¦åˆæˆ˜ç•¥å±‚çš„é£æ§è¦æ±‚

3. **ç¼ºå°‘å®‰å…¨ç½‘**
   - å³ä½¿ Trader ç”Ÿæˆäº†ä¸åˆç†çš„ä¿¡å·ï¼ˆå¦‚ panic æ¨¡å¼ä¸‹è¿˜è¦å¼€æ–°ä»“ï¼‰
   - æ‰§è¡Œå±‚ä¹Ÿä¼šç…§å•å…¨æ”¶
   - **æ²¡æœ‰æœ€åä¸€é“é˜²çº¿**

---

## âœ… è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆAï¼šæç¤ºè¯å¢å¼ºï¼ˆé¦–é€‰ï¼‰

åœ¨ Trader æç¤ºè¯ä¸­æ·»åŠ æ˜ç¡®çš„å¼ºåˆ¶è§„åˆ™ï¼š

```markdown
## âš ï¸ æˆ˜ç•¥é£æ§è¦æ±‚ï¼ˆå¿…é¡»éµå®ˆï¼ï¼‰

å½“å‰äº¤æ˜“æ¨¡å¼: {trading_mode}
ç›®æ ‡ç°é‡‘æ¯”ä¾‹: {cash_ratio}

**å¦‚æœ trading_mode = "panic"ï¼š**
1. âœ… å¿…é¡»è¯„ä¼°ç°æœ‰æŒä»“æ˜¯å¦éœ€è¦ç´§æ€¥å¹³ä»“
   - é«˜æ æ†(>10x)æŒä»“ â†’ å¼ºçƒˆå»ºè®®ç«‹å³å¹³ä»“
   - äºæŸæŒä»“ â†’ è€ƒè™‘æ­¢æŸ

2. âŒ ä¸¥ç¦å¼€æ–°ä»“

3. âœ… å¿…é¡»ä¸ºæ‰€æœ‰æŒä»“è®¾ç½®ä¸¥æ ¼æ­¢æŸ

**å½“å‰æŒä»“åˆ†æ**:
{portfolio_positions}

ä½ å¿…é¡»å›ç­”:
1. æŒä»“ä¸­æ˜¯å¦æœ‰é«˜æ æ†ï¼Ÿåœ¨panicæ¨¡å¼ä¸‹æ˜¯å¦åº”è¯¥å¹³ä»“ï¼Ÿ
2. å½“å‰ç°é‡‘æ¯”ä¾‹æ˜¯å¦è¾¾åˆ°{cash_ratio}ï¼Ÿå¦‚æœæ²¡æœ‰ï¼Œåº”è¯¥å¹³ä»“å“ªäº›ï¼Ÿ
```

### æ–¹æ¡ˆBï¼šæ‰§è¡Œå±‚æ£€æŸ¥ï¼ˆå¤‡é€‰ï¼‰

åœ¨ TradingExecutor ä¸­æ·»åŠ æˆ˜ç•¥é£æ§æ£€æŸ¥ï¼š

```python
# åœ¨ process_trading_signal() å¼€å§‹æ—¶
def _check_strategic_violations(signal, portfolio, market_regime):
    """æ£€æŸ¥æ˜¯å¦è¿åæˆ˜ç•¥é£æ§è¦æ±‚"""

    if market_regime.trading_mode == "panic":
        # ææ…Œæ¨¡å¼ä¸‹ç¦æ­¢å¼€æ–°ä»“
        if signal.signal_type in [ENTER_LONG, ENTER_SHORT]:
            return "ææ…Œæ¨¡å¼ä¸‹ç¦æ­¢å¼€æ–°ä»“"

        # æ£€æŸ¥å½“å‰é£é™©æš´éœ²
        risk_exposure = 1 - (portfolio.cash / portfolio.total_value)
        if risk_exposure > (1 - market_regime.cash_ratio):
            # é£é™©è¿‡é«˜ä½†è¿˜åœ¨ hold
            if signal.signal_type == HOLD:
                return "é£é™©æš´éœ²è¿‡é«˜ï¼Œéœ€è¦å‡ä»“"

    return None  # æ— è¿å
```

### æ–¹æ¡ˆCï¼šä¸»åŠ¨é£æ§è°ƒæ•´å™¨ï¼ˆæœ€å®Œå–„ï¼‰

åˆ›å»ºä¸€ä¸ªç‹¬ç«‹çš„é£æ§æ£€æŸ¥å™¨ï¼Œä¸ä¾èµ– LLM åˆ¤æ–­ï¼š

```python
class RiskAdjuster:
    async def check_and_adjust_positions(portfolio, market_regime):
        """æ£€æŸ¥æŒä»“å¹¶ç”Ÿæˆè°ƒæ•´ä¿¡å·"""

        adjustment_signals = []

        # æ£€æŸ¥é£é™©æš´éœ²
        risk_exposure = 1 - (portfolio.cash / portfolio.total_value)
        target_risk = 1 - market_regime.cash_ratio

        if risk_exposure > target_risk * 1.2:  # è¶…å‡º20%
            # ç”Ÿæˆå‡ä»“ä¿¡å·
            for position in portfolio.positions:
                if market_regime.trading_mode == "panic" and position.leverage > 10:
                    # ææ…Œæ¨¡å¼ + é«˜æ æ† â†’ å¼ºåˆ¶å¹³ä»“
                    signal = TradingSignal(
                        signal_type=EXIT_SHORT,
                        confidence=0.95,
                        reasoning=f"ææ…Œæ¨¡å¼ä¸‹è‡ªåŠ¨å¹³ä»“é«˜æ æ†({position.leverage}x)æŒä»“",
                        # ...
                    )
                    adjustment_signals.append(signal)

        return adjustment_signals
```

---

## ğŸ“‹ å‚æ•°ä¼ é€’æ€»ç»“è¡¨

| å±‚çº§ | è¾“å‡ºæ•°æ® | å…³é”®å­—æ®µ | æ¥æ”¶æ–¹ | ç”¨é€” |
|------|---------|---------|--------|------|
| Strategist | `MarketRegime` | `trading_mode`<br>`cash_ratio`<br>`position_sizing_multiplier`<br>`risk_level` | Trader | æŒ‡å¯¼æˆ˜æœ¯å†³ç­– |
| Trader | `TradingSignal` | `signal_type`<br>`suggested_price`<br>`suggested_amount`<br>`stop_loss`<br>`take_profit`<br>`leverage`<br>`reasoning` | TradingExecutor | æ‰§è¡Œäº¤æ˜“ |
| TradingExecutor | `Order` | `symbol`<br>`side`<br>`type`<br>`amount`<br>`price`<br>`stop_loss`<br>`take_profit`<br>`leverage` | OrderExecutor | ä¸‹å•åˆ°äº¤æ˜“æ‰€ |

## ğŸ¯ å½“å‰é—®é¢˜å’Œä¿®å¤çŠ¶æ€

| é—®é¢˜ | çŠ¶æ€ | è¯´æ˜ |
|------|------|------|
| Strategist â†’ Trader æ•°æ®ä¼ é€’ | âœ… æ­£å¸¸ | `trading_mode`ã€`cash_ratio` ç­‰å·²ä¼ é€’ |
| Trader æç¤ºè¯å¼ºåˆ¶è§„åˆ™ | âŒ ç¼ºå¤± | æ²¡æœ‰æ˜ç¡®å‘Šè¯‰ LLM åº”è¯¥åšä»€ä¹ˆ |
| TradingExecutor æˆ˜ç•¥æ£€æŸ¥ | âŒ ç¼ºå¤± | æ²¡æœ‰éªŒè¯ä¿¡å·æ˜¯å¦ç¬¦åˆæˆ˜ç•¥è¦æ±‚ |
| ä¸»åŠ¨é£æ§è°ƒæ•´ | âŒ æœªå®ç° | æ²¡æœ‰ç‹¬ç«‹çš„é£æ§æ£€æŸ¥å™¨ |

**å»ºè®®ä¼˜å…ˆçº§**ï¼š
1. ä¿®å¤ Trader æç¤ºè¯ï¼ˆæœ€å¿«ï¼Œæˆæœ¬æœ€ä½ï¼‰
2. æ·»åŠ æ‰§è¡Œå±‚æ£€æŸ¥ï¼ˆé˜²æ­¢é‡å¤§é£æ§å¤±è¯¯ï¼‰
3. å®ç°ä¸»åŠ¨é£æ§è°ƒæ•´å™¨ï¼ˆæœ€å®Œå–„çš„è§£å†³æ–¹æ¡ˆï¼‰
