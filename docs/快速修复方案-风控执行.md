# 风控执行断档 - 快速修复方案

## 🎯 问题核心

**症状**：Strategist 判定 panic 模式 + 80%现金，但 Trader 仍然输出 hold，持仓保持不变。

**根本原因**：
1. ✅ 数据已经传递（trading_mode、cash_ratio 等）
2. ❌ **提示词缺少明确的行动指令**
3. ❌ LLM 不知道 panic/defensive 模式下应该**主动减仓/平仓**

## ⚡ 立即修复方案

### 修改文件：`src/decision/prompt_templates.py`

找到 Trader 的提示词模板，在**战略判断部分**添加明确的行动指令。

**关键修改点**：

在提示词中添加这样的部分：

```markdown
## ⚠️ 战略风控要求（必须遵守！）

当前市场状态: {regime}
风险等级: {risk_level}
交易模式: {trading_mode}
目标现金比例: {cash_ratio}
仓位系数: {position_multiplier}x

### 🚨 强制执行规则

**如果交易模式 = "panic"（恐慌模式）：**
1. ✅ **必须评估现有持仓是否需要紧急平仓**
   - 特别是高杠杆持仓（>10x）**强烈建议立即平仓**
   - 亏损持仓应考虑止损
   - 现金比例必须向 {cash_ratio} 目标靠近

2. ❌ **严禁开新仓**（除非有极其明确的套利机会且信心度>0.9）

3. ✅ **必须为所有持仓设置严格止损**

**如果交易模式 = "defensive"（防御模式）：**
1. ✅ **评估是否需要减仓**
   - 如果当前现金比例 < {cash_ratio}，考虑部分平仓
   - 高杠杆持仓（>10x）应考虑降杠杆或减仓

2. ⚠️  **极度谨慎开新仓**
   - 只有在信心度 > 0.8 且技术指标强烈共振时才考虑
   - 仓位不超过正常水平的 {position_multiplier}

3. ✅ **必须设置止损止盈**

**如果交易模式 = "aggressive"（积极模式）：**
1. ✅ 可以正常开仓，仓位可放大到 {position_multiplier} 倍
2. ✅ 但仍需严格风控，必须设置止损止盈

---

### 📊 当前持仓分析（关键！）

{portfolio_positions}

**你必须回答以下问题：**
1. 当前持仓中是否有高杠杆（>10x）？如果有，在当前{trading_mode}模式下是否应该平仓或降杠杆？
2. 当前现金比例是否达到战略层要求的 {cash_ratio}？如果没有，应该平仓哪些持仓来增加现金？
3. 是否有持仓没有设置止损？在当前风险等级下是否应该补充止损？
```

## 🔧 具体实施步骤

由于我无法直接修改提示词模板（文件较大且可能有多个版本），请你按照以下步骤操作：

### 步骤1：找到 Trader 提示词模板

```bash
# 查找 trader 提示词相关代码
cd /Users/wins/work/crypto-trading-system/backend
grep -n "交易模式.*trading_mode" src/decision/prompt_templates.py
```

### 步骤2：在模板中添加强制规则部分

在提示词的**战略判断**或**当前策略**部分之后，添加上面的"强制执行规则"内容。

### 步骤3：测试验证

重启系统后，观察日志：

```bash
# 查看 Trader 的决策理由
grep -A 20 "reasoning" logs/trading_system.log | tail -50
```

**预期效果**：
- Panic 模式下，应该看到 `exit_short` 或 `exit_long` 信号
- reasoning 中应该提到"恐慌模式下平仓高杠杆持仓"

## 🎯 预期改进

修改前：
```
Mode: panic, 现金目标80%
→ Trader: hold (什么都不做)
→ 持仓保持：BTC 20x, ETH 100x
```

修改后：
```
Mode: panic, 现金目标80%
→ Trader: exit_short (平仓ETH 100x高杠杆持仓)
→ Trader: exit_short (平仓部分BTC减少风险)
→ 现金比例提升至70-80%
```

## 📝 长期方案

如果提示词修改后仍然效果不佳，需要实施：

1. **执行层主动检查**（方案2）：
   - 在 TradingExecutor 中检查信号是否符合战略要求
   - 违反时拒绝执行或强制调整

2. **自动风控调整器**（方案3）：
   - 定期检查持仓
   - 自动生成风控调整信号
   - 不依赖 LLM 判断

但首先应该尝试修复提示词，因为这是最简单且最符合 AI 决策架构的方案。
