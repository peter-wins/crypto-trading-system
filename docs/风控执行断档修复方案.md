# 风控执行断档问题修复方案

## 🔴 问题描述

**症状**：
- Strategist 判定：panic模式 + 80%现金 + 防御性配置
- Trader 输出：hold 信号（不做任何操作）
- 实际持仓：BTC 20x空单、ETH 100x空单保持不变，无止损止盈
- 风险暴露：~50%（远超防御模式要求）

**根本原因**：
1. **信息传递断档**：Strategist 的风控要求（cash_ratio、trading_mode、position_sizing_multiplier）没有传递给 Trader
2. **Trader 提示词缺失**：Trader 层提示词中没有强调必须遵守战略层的风控要求
3. **执行层被动**：TradingExecutor 收到 hold 信号后什么都不做，不会主动检查风险

## 💡 解决方案

### 方案1：增强 Strategist → Trader 的信息传递（立即实施）

**修改位置**：`src/decision/prompts.py` - `build_trader_prompt()` 方法

**当前问题**：
- strategy_description 中包含了战略判断，但格式不够强制性
- 没有单独突出显示 cash_ratio 等关键风控参数

**修改方案**：

```python
# 在 build_trader_prompt 中添加战略风控要求部分
def build_trader_prompt(symbol: str, context: Dict[str, Any]) -> str:
    # ... 现有代码 ...

    # 新增：提取战略层风控要求
    strategy_config = context.get("strategy_config", {})
    trading_mode = strategy_config.get("trading_mode", "normal")
    cash_ratio_target = strategy_config.get("cash_ratio", 0.2)
    position_multiplier = strategy_config.get("position_sizing_multiplier", 1.0)
    risk_level = strategy_config.get("risk_level", "medium")

    # 新增：战略风控要求部分
    strategic_requirements = f"""
=== ⚠️  战略层风控要求（必须遵守）===
交易模式: {trading_mode}
目标现金比例: {cash_ratio_target * 100:.0f}%
风险等级: {risk_level}
仓位系数: {position_multiplier}x

🚨 **强制要求**：
"""

    if trading_mode == "defensive":
        strategic_requirements += f"""
- 当前为**防御模式**，优先降低风险暴露
- 目标现金比例 {cash_ratio_target * 100:.0f}%，当前可能过低
- 如果持仓过大，**必须考虑减仓或平仓**
- 如果有高杠杆持仓（>10x），**必须评估是否降杠杆或平仓**
- 新开仓必须极度谨慎，仓位不超过 {position_multiplier * 100:.0f}% 正常水平
"""
    elif trading_mode == "panic":
        strategic_requirements += f"""
- 当前为**恐慌模式**，必须大幅降低风险
- 目标现金比例 {cash_ratio_target * 100:.0f}%，**立即评估是否需要紧急平仓**
- 所有高杠杆持仓（>5x）**强烈建议平仓或大幅减仓**
- **严禁**开新仓，除非有极其明确的套利机会
- 必须为所有持仓设置严格止损
"""
    elif trading_mode == "aggressive":
        strategic_requirements += f"""
- 当前为**积极模式**，可以适当增加风险暴露
- 目标现金比例 {cash_ratio_target * 100:.0f}%
- 仓位可以放大到 {position_multiplier * 100:.0f}% 正常水平
- 但仍需严格风控，必须设置止损止盈
"""

    strategic_requirements += "\n"

    # 在原有 prompt 中插入战略风控要求
    prompt = (
        f"当前时间：{now_str}\n\n"
        f"{strategic_requirements}\n"  # 新增部分
        f"=== 分析目标 ===\n{symbol}\n"
        # ... 其余部分保持不变 ...
    )
```

### 方案2：添加执行层风控检查（中期实施）

**修改位置**：`src/execution/trading_executor.py` - `execute_trading_signal()` 方法

**新增功能**：在执行信号前检查是否符合战略风控要求

```python
async def execute_trading_signal(
    self,
    signal: TradingSignal,
    snapshot: "MarketSnapshot",
    strategy_config: Optional[StrategyConfig] = None,  # 新增参数
) -> Optional["Portfolio"]:
    """执行交易信号"""

    # 新增：战略风控检查
    if strategy_config:
        portfolio = await self.portfolio_manager.get_current_portfolio()
        violation = self._check_strategic_violations(
            signal, portfolio, strategy_config
        )

        if violation:
            self.logger.warning(
                f"🚫 信号 {signal.signal_type} 违反战略风控要求: {violation}"
            )
            # 选项1：直接拒绝信号
            return None
            # 选项2：调整信号参数后执行
            # signal = self._adjust_signal_for_strategy(signal, strategy_config)

    # 原有执行逻辑...

def _check_strategic_violations(
    self,
    signal: TradingSignal,
    portfolio: Portfolio,
    strategy_config: StrategyConfig,
) -> Optional[str]:
    """检查是否违反战略风控要求"""

    # 计算当前风险暴露
    risk_exposure = 1 - (portfolio.cash / portfolio.total_value)
    target_cash_ratio = strategy_config.cash_ratio

    # 防御/恐慌模式下的检查
    if strategy_config.trading_mode in ["defensive", "panic"]:
        # 现金不足且还要开新仓
        if risk_exposure > (1 - target_cash_ratio):
            if signal.signal_type in [SignalType.ENTER_LONG, SignalType.ENTER_SHORT]:
                return f"防御模式下现金不足 (当前 {portfolio.cash:.2f}, 需要 {portfolio.total_value * target_cash_ratio:.2f})"

        # 恐慌模式下禁止开新仓
        if strategy_config.trading_mode == "panic":
            if signal.signal_type in [SignalType.ENTER_LONG, SignalType.ENTER_SHORT]:
                return "恐慌模式下禁止开新仓"

    # 检查杠杆是否过高
    if signal.leverage and signal.leverage > 10:
        if strategy_config.trading_mode in ["defensive", "panic"]:
            return f"防御/恐慌模式下不允许高杠杆 (信号杠杆={signal.leverage}x)"

    return None
```

### 方案3：添加主动风控调整（高级功能）

**新增模块**：`src/execution/risk_adjuster.py`

**功能**：定期检查持仓，如果发现与战略要求严重不符，主动生成调整信号

```python
class RiskAdjuster:
    """风险自动调整器"""

    async def check_and_adjust_positions(
        self,
        portfolio: Portfolio,
        strategy_config: StrategyConfig,
    ) -> List[TradingSignal]:
        """检查持仓并生成调整信号"""

        adjustment_signals = []

        # 计算当前风险暴露
        risk_exposure = 1 - (portfolio.cash / portfolio.total_value)
        target_cash_ratio = strategy_config.cash_ratio

        # 风险暴露过高
        if risk_exposure > (1 - target_cash_ratio) * 1.2:  # 超出目标20%
            self.logger.warning(
                f"⚠️  风险暴露过高: {risk_exposure*100:.1f}%, "
                f"目标: {(1-target_cash_ratio)*100:.1f}%"
            )

            # 生成减仓信号
            if strategy_config.trading_mode == "panic":
                # 恐慌模式：平掉最大/最危险的持仓
                for position in sorted(
                    portfolio.positions,
                    key=lambda p: abs(p.unrealized_pnl),  # 按亏损排序
                    reverse=True
                ):
                    if position.leverage and position.leverage > 10:
                        # 高杠杆持仓优先平仓
                        signal = TradingSignal(
                            symbol=position.symbol,
                            signal_type=SignalType.EXIT_LONG if position.side == OrderSide.BUY else SignalType.EXIT_SHORT,
                            confidence=0.9,
                            reasoning=f"恐慌模式下自动平仓高杠杆持仓 ({position.leverage}x)",
                            risk_factors=["high_leverage", "panic_mode"],
                        )
                        adjustment_signals.append(signal)

        return adjustment_signals
```

## 📋 实施计划

### 第一阶段（立即）：信息传递修复
1. ✅ 修改 `build_trader_prompt()` - 添加战略风控要求部分
2. ✅ 在 Trader 提示词中强调必须遵守战略要求
3. ✅ 测试验证：防御模式下是否能生成减仓信号

### 第二阶段（本周）：执行层检查
1. 在 TradingExecutor 中添加战略风控检查
2. 违反风控要求时拒绝或调整信号
3. 记录所有风控拦截事件

### 第三阶段（下周）：主动风控调整
1. 实现 RiskAdjuster 模块
2. 在 LayeredDecisionCoordinator 中定期调用
3. 自动生成风控调整信号

## 🎯 预期效果

**修复后的流程**：
```
Strategist 决策: panic + 80%现金
    ↓
传递给 Trader: 明确的风控要求
    ↓
Trader 生成信号: exit_short (平掉高杠杆空单)
    ↓
TradingExecutor: 检查是否符合风控要求
    ↓
执行平仓: 降低风险暴露到目标水平
    ↓
RiskAdjuster 验证: 风险已降低 ✅
```

## 📝 测试验证

修复后应该能看到：
1. 防御模式下，Trader 输出 `exit_long/exit_short` 而不是 `hold`
2. 高杠杆持仓（>10x）在恐慌模式下被自动平仓
3. 现金比例逐步调整到目标水平
4. 日志中记录风控调整的完整过程
