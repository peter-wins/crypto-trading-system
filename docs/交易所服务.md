📊 当前系统与交易所交互分析

  当前使用交易所API的地方：

  1. 执行层 (Execution)

  - order.py - 订单管理
    - create_order() - 创建订单
    - fetch_order() - 查询订单状态
    - fetch_open_orders() - 获取未完成订单
    - fetch_order_trades() - 获取订单成交记录
  - portfolio.py - 投资组合管理
    - fetch_balance() - 获取账户余额
    - fetch_positions() - 获取持仓信息
    - fetch_open_orders() - 获取未完成订单

  2. 感知层 (Perception)

  - market_data.py - 市场数据
    - fetch_ticker() - 获取最新价格
    - fetch_ohlcv() - 获取K线数据
    - fetch_order_book() - 获取订单簿
    - fetch_status() - 获取交易所状态

  当前问题：

  1. 重复代码 - 每个模块都有自己的 _get_exchange() 方法
  2. 连接管理分散 - 缺乏统一的连接池和错误处理
  3. 没有统一的限流 - 容易触发交易所API限制
  4. 没有统一的日志 - 难以追踪API调用
  5. 难以切换交易所 - 如果要换交易所，需要修改多处

  💡 重构建议：创建统一的交易所服务层

  我建议创建一个新的 src/exchange/ 模块，作为统一的交易所服务层：

  src/exchange/
  ├── __init__.py
  ├── exchange_service.py      # 核心交易所服务（单例）
  ├── exchange_factory.py      # 交易所工厂类
  ├── rate_limiter.py          # 统一限流器
  ├── exceptions.py            # 交易所相关异常
  └── decorators.py            # 重试、日志等装饰器

  架构设计：

  # exchange_service.py - 核心服务
  class ExchangeService:
      """统一的交易所服务（单例模式）"""

      # 市场数据相关
      async def fetch_ticker(symbol: str) -> Dict
      async def fetch_ohlcv(symbol: str, timeframe: str) -> List
      async def fetch_order_book(symbol: str) -> Dict

      # 账户相关
      async def fetch_balance() -> Dict
      async def fetch_positions() -> List

      # 订单相关
      async def create_order(...) -> Dict
      async def cancel_order(order_id: str) -> Dict
      async def fetch_order(order_id: str) -> Dict
      async def fetch_open_orders(symbol: str) -> List

      # 连接管理
      async def connect()
      async def disconnect()
      async def reconnect()

  优势：

  1. ✅ 单一职责 - 所有交易所交互集中管理
  2. ✅ 连接复用 - 共享exchange实例，避免重复连接
  3. ✅ 统一限流 - 避免触发API限制
  4. ✅ 统一错误处理 - 重试、降级、熔断
  5. ✅ 统一日志 - 所有API调用都有日志
  6. ✅ 易于测试 - 可以mock整个服务
  7. ✅ 易于扩展 - 支持多交易所、WebSocket等

  实现方案

  我可以帮你实现这个统一的交易所服务层。你觉得这个方向如何？我们可以：

  方案A：渐进式重构（推荐）
  1. 先创建 ExchangeService 作为统一入口
  2. 保留现有代码，逐步迁移到新服务
  3. 确保不影响当前运行

  方案B：激进重构
  1. 直接创建新的exchange模块
  2. 一次性修改所有调用点
  3. 彻底重构

